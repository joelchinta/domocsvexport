name: Domo Export

on:
  repository_dispatch:
    types: [domo_export]
  workflow_dispatch:

env:
  PLAYWRIGHT_BROWSERS_PATH: 0

jobs:
  run-export:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - run: npm ci

      - run: npx playwright install --with-deps chromium

      - name: Mask sensitive secrets in logs
        shell: bash
        run: |
          mask_if_set() {
            local candidate="$1"
            if [ -n "$candidate" ]; then
              echo "::add-mask::${candidate}"
            fi
          }

          mask_if_set "${{ secrets.DOMO_BASE_URL }}"
          mask_if_set "${{ secrets.DOMO_USERNAME }}"
          mask_if_set "${{ secrets.DOMO_PASSWORD }}"
          mask_if_set "${{ secrets.DOMO_VENDOR_ID }}"
          mask_if_set "${{ secrets.EMAIL_USER }}"
          mask_if_set "${{ secrets.EMAIL_TO }}"
          mask_if_set "${{ secrets.EMAIL_HOST }}"
          mask_if_set "${{ secrets.EMAIL_PORT }}"
          mask_if_set "${{ secrets.EMAIL_PASS }}"
          mask_if_set "${{ secrets.GOOGLE_CLIENT_ID }}"
          mask_if_set "${{ secrets.GOOGLE_CLIENT_SECRET }}"
          mask_if_set "${{ secrets.GOOGLE_REFRESH_TOKEN }}"
          mask_if_set "${{ secrets.EMAIL_SUBJECT }}"
          mask_if_set "${{ secrets.EMAIL_BODY }}"

      - run: npm start
        env:
          DOMO_BASE_URL: ${{ secrets.DOMO_BASE_URL }}
          DOMO_USERNAME: ${{ secrets.DOMO_USERNAME }}
          DOMO_PASSWORD: ${{ secrets.DOMO_PASSWORD }}
          DOMO_VENDOR_ID: ${{ secrets.DOMO_VENDOR_ID }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          EMAIL_SUBJECT: ${{ secrets.EMAIL_SUBJECT }}
          EMAIL_BODY: ${{ secrets.EMAIL_BODY }}
